generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

//////////////////////////
// ENUMS
//////////////////////////

enum Role {
  admin
  teacher
  accounts
  staff
}

enum StudentStatus {
  active
  inactive
}

enum AttendanceStatus {
  present
  absent
}

enum PaymentMode {
  cash
  upi
  bank
}

enum EventType {
  attendance_marked
  student_absent
  fee_created
  fee_paid
  fee_overdue
  fee_reminder
  birthday
}

enum EventStatus {
  pending
  processed
  failed
}

enum NotificationStatus {
  pending
  sent
  failed
}

enum JobStatus {
  running
  completed
  failed
  skipped
}

enum StaffAttendanceStatus {
  present
  absent
  half_day
  leave
}

enum EmploymentType {
  full_time
  part_time
  contract
}

enum LeaveType {
  casual
  sick
  earned
  unpaid
}

// Student Leave Enums (Phase 4)
enum StudentLeaveStatus {
  pending
  approved
  rejected
  cancelled
}

enum StudentLeaveType {
  sick
  family
  vacation
  medical
  other
}

// Academic Calendar Enums (Phase 3)
enum AcademicEventType {
  holiday
  exam
  ptm
  event
  deadline
}

// Phase 2B Enums
enum PaymentLinkStatus {
  active
  expired
  paid
  cancelled
}

enum ReportType {
  attendance_monthly
  attendance_batch
  fee_collection
  fee_defaulters
  student_performance
  branch_summary
}

enum ReportFormat {
  pdf
  excel
}

enum ExamType {
  unit_test
  mid_term
  final
  practical
  assignment
}

enum MessageType {
  direct
  broadcast
  announcement
}

enum ComplaintStatus {
  open
  in_progress
  resolved
  closed
}

enum ComplaintPriority {
  low
  medium
  high
  urgent
}

// Phase 5: Homework Enums
enum HomeworkStatus {
  draft
  published
  closed
}

enum SubmissionStatus {
  pending
  submitted
  late
  graded
}

// Phase 3: Fee System Enums
enum FeeComponentType {
  tuition
  admission
  transport
  lab
  library
  sports
  exam
  uniform
  misc
}

enum ScholarshipType {
  percentage       // Percentage off total (e.g., 25% off)
  fixed_amount     // Fixed amount discount (e.g., â‚¹5000 off)
  component_waiver // Waive specific component (e.g., transport)
}

enum ScholarshipBasis {
  merit
  need_based
  sports
  sibling
  staff_ward
  government
  custom
}

enum FeeStructureSource {
  batch_default // Copied from batch fee structure
  custom        // Manually set for student
}

enum InstallmentStatus {
  upcoming
  due
  overdue
  partial
  paid
}

// Phase 3: Health Enums
enum BloodGroup {
  A_positive
  A_negative
  B_positive
  B_negative
  AB_positive
  AB_negative
  O_positive
  O_negative
  unknown
}

enum VisionStatus {
  normal
  corrected_with_glasses
  corrected_with_lenses
  impaired
}

enum HearingStatus {
  normal
  mild_impairment
  moderate_impairment
  severe_impairment
}

//////////////////////////
// CORE TENANCY
//////////////////////////

model Organization {
  id        String   @id @default(uuid())
  name      String
  type      String // "school" | "coaching"
  language  String   @default("en")
  timezone  String   @default("Asia/Kolkata")
  udiseCode String? // optional
  logoUrl   String?  @db.Text // Base64 encoded organization logo
  phone     String?  // Contact phone number
  email     String?  // Contact email address
  address   String?  // Primary address
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Notification Settings
  notificationsEnabled     Boolean @default(true)
  feeOverdueCheckTime      String  @default("09:00") // HH:mm format
  feeReminderDays          Int     @default(3)       // Days before due date to send reminder
  birthdayNotifications    Boolean @default(true)
  attendanceBufferMinutes  Int     @default(5)       // Minutes after first period to start processing

  // Feature Flags
  jobsDashboardEnabled Boolean @default(false)

  branches         Branch[]
  users            User[]
  students         Student[]
  parents          Parent[]
  events           Event[]
  templates        MessageTemplate[]
  academicSessions AcademicSession[]
  subjects         Subject[]
  periodTemplates  PeriodTemplate[]
  jobRuns          JobRun[]
  staffAttendance  StaffAttendance[]
  receipts         Receipt[]

  // Phase 3 Relations
  feeComponents    FeeComponent[]
  scholarships     Scholarship[]
  emiPlanTemplates EMIPlanTemplate[]
  academicEvents   AcademicEvent[]
  homework         Homework[]
}

model Branch {
  id        String   @id @default(uuid())
  orgId     String
  name      String
  address   String?
  city      String?
  state     String?
  pincode   String?
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id])
  users        User[]
  students     Student[]
  batches      Batch[]
  parents      Parent[]
  events       Event[]
  notifications NotificationLog[]
  academicEvents AcademicEvent[]
  homework       Homework[]
}

//////////////////////////
// USERS & RBAC
//////////////////////////

model User {
  id                 String   @id @default(uuid())
  orgId              String
  branchId           String
  employeeId         String   @unique // Auto-generated (e.g., "XK7R2M")
  passwordHash       String            // bcrypt hashed password
  mustChangePassword Boolean  @default(true) // Force password change on first login
  firstName          String
  lastName           String
  phone              String
  email              String?
  photoUrl           String?  @db.Text // Base64 encoded profile photo
  role               Role
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Staff Profile Fields
  employmentType   EmploymentType? // full_time | part_time | contract
  joiningDate      DateTime?
  department       String?
  designation      String?
  salary           Int?            // Basic monthly salary (for Phase 3 payroll)
  emergencyContact String?

  organization Organization @relation(fields: [orgId], references: [id])
  branch       Branch       @relation(fields: [branchId], references: [id])

  classTeacherBatches Batch[]             @relation("ClassTeacher")
  attendanceSessions  AttendanceSession[]
  periods             Period[]
  staffAttendance     StaffAttendance[]
  receiptsGenerated   Receipt[]           @relation("ReceiptReceivedBy")
  
  // Phase 2B Relations
  paymentLinksCreated        PaymentLink[]              @relation("PaymentLinkCreatedBy")
  reportsRequested           ReportGeneration[]
  examsCreated               Exam[]                     @relation("ExamCreatedBy")
  examScoresGraded           ExamScore[]                @relation("ExamScoreGradedBy")
  conversationParticipations ConversationParticipant[]  @relation("UserParticipant")
  messagesSent               Message[]                  @relation("MessageSentByUser")
  complaintsAssigned         Complaint[]                @relation("ComplaintAssignedTo")
  complaintComments          ComplaintComment[]         @relation("ComplaintCommentByUser")

  // Phase 3 Relations
  scholarshipsApproved StudentScholarship[] @relation("ScholarshipApprovedBy")
  installmentPayments  InstallmentPayment[] @relation("InstallmentReceivedBy")

  // Phase 4 Relations
  leaveApplicationsReviewed LeaveApplication[] @relation("LeaveReviewedBy")
  academicEventsCreated     AcademicEvent[]    @relation("AcademicEventCreatedBy")

  // Phase 5 Relations
  homeworkCreated      Homework[]           @relation("HomeworkCreatedBy")
  submissionsGraded    HomeworkSubmission[] @relation("SubmissionGradedBy")
}

//////////////////////////
// STUDENTS & PARENTS
//////////////////////////

model Student {
  id            String        @id @default(uuid())
  orgId         String
  branchId      String
  firstName     String
  lastName      String
  gender        String?
  dob           DateTime?
  category      String? // gen / sc / st / obc / minority (optional)
  isCwsn        Boolean       @default(false)
  photoUrl      String?       @db.Text // Base64 encoded profile photo
  admissionYear Int
  status        StudentStatus @default(active)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  organization Organization @relation(fields: [orgId], references: [id])
  branch       Branch       @relation(fields: [branchId], references: [id])

  studentParents    StudentParent[]
  batch             Batch?             @relation(fields: [batchId], references: [id])
  batchId           String?
  attendanceRecords AttendanceRecord[]
  receipts          Receipt[]
  
  // Phase 2B Relations
  examScores  ExamScore[]
  complaints  Complaint[]

  // Phase 3 Relations
  health         StudentHealth?
  healthCheckups HealthCheckup[]
  feeStructures  StudentFeeStructure[]
  scholarships   StudentScholarship[]

  // Phase 4 Relations
  leaveApplications LeaveApplication[]

  // Phase 5 Relations
  homeworkSubmissions HomeworkSubmission[]

  // Phase 6: Emergency Contacts
  // JSON array: [{id, name, relation, phone, isPrimary, notes}]
  emergencyContacts Json?
}

model Parent {
  id        String   @id @default(uuid())
  orgId     String
  branchId  String
  firstName String
  lastName  String
  phone     String
  email     String?
  photoUrl  String?  @db.Text // Base64 encoded profile photo
  createdAt DateTime @default(now())

  organization Organization? @relation(fields: [orgId], references: [id])
  branch       Branch        @relation(fields: [branchId], references: [id])
  students     StudentParent[]
  otpCodes     OtpCode[]
  sessions     ParentSession[]
  
  // Phase 2B Relations
  conversationParticipations ConversationParticipant[] @relation("ParentParticipant")
  messagesSent               Message[]                 @relation("MessageSentByParent")
  complaintsSubmitted        Complaint[]               @relation("ComplaintSubmittedByParent")
  complaintComments          ComplaintComment[]        @relation("ComplaintCommentByParent")

  // Phase 3 Relations
  feeReminders FeeReminder[]

  // Phase 4 Relations
  leaveApplications LeaveApplication[]
}

// OTP codes for parent login
model OtpCode {
  id        String   @id @default(uuid())
  phone     String
  code      String
  parentId  String
  expiresAt DateTime
  verified  Boolean  @default(false)
  attempts  Int      @default(0)
  createdAt DateTime @default(now())

  parent Parent @relation(fields: [parentId], references: [id])

  @@index([phone, expiresAt])
  @@index([parentId])
}

// Parent session tokens for authenticated access
model ParentSession {
  id         String   @id @default(uuid())
  parentId   String
  token      String   @unique
  expiresAt  DateTime
  deviceInfo String?  // JSON with device details
  createdAt  DateTime @default(now())

  parent Parent @relation(fields: [parentId], references: [id])

  @@index([parentId])
  @@index([token])
}

model StudentParent {
  studentId        String
  parentId         String
  relation         String // father | mother | guardian
  isPrimaryContact Boolean @default(false)

  student Student @relation(fields: [studentId], references: [id])
  parent  Parent  @relation(fields: [parentId], references: [id])

  @@id([studentId, parentId])
}

//////////////////////////
// ACADEMIC SESSIONS
//////////////////////////

model AcademicSession {
  id        String   @id @default(uuid())
  orgId     String
  name      String // "2025-26"
  startDate DateTime
  endDate   DateTime
  isCurrent Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id])
  batches      Batch[]

  // Phase 3 Relations
  batchFeeStructures   BatchFeeStructure[]
  studentFeeStructures StudentFeeStructure[]
  studentScholarships  StudentScholarship[]
}

//////////////////////////
// SUBJECTS
//////////////////////////

model Subject {
  id        String   @id @default(uuid())
  orgId     String
  name      String // "Mathematics"
  code      String // "MATH"
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id])
  periods      Period[]
  exams        Exam[]
  homework     Homework[]  @relation("HomeworkSubject")

  @@unique([orgId, code])
}

//////////////////////////
// PERIOD TEMPLATES
//////////////////////////

model PeriodTemplate {
  id         String   @id @default(uuid())
  orgId      String
  name       String // "Default", "Half Day"
  isDefault  Boolean  @default(false)
  activeDays Int[]    @default([1, 2, 3, 4, 5, 6]) // 1=Mon to 6=Sat
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  organization Organization         @relation(fields: [orgId], references: [id])
  slots        PeriodTemplateSlot[]
}

model PeriodTemplateSlot {
  id           String  @id @default(uuid())
  templateId   String
  periodNumber Int // 1, 2, 3... (0 for breaks)
  startTime    String // "08:00"
  endTime      String // "08:45"
  isBreak      Boolean @default(false)
  breakName    String? // "Lunch", "Recess"

  template PeriodTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, periodNumber])
}

//////////////////////////
// BATCHES & ATTENDANCE
//////////////////////////

model Batch {
  id             String   @id @default(uuid())
  orgId          String
  branchId       String
  sessionId      String? // Academic session
  name           String
  academicLevel  String // primary | secondary | senior_secondary | coaching
  stream         String?
  classTeacherId String? // Primary class teacher
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  branch             Branch              @relation(fields: [branchId], references: [id])
  session            AcademicSession?    @relation(fields: [sessionId], references: [id])
  students           Student[]
  classTeacher       User?               @relation("ClassTeacher", fields: [classTeacherId], references: [id])
  attendanceSessions AttendanceSession[]
  periods            Period[]
  
  // Phase 2B Relations
  exams         Exam[]
  conversations Conversation[]

  // Phase 3 Relations
  feeStructures  BatchFeeStructure[]
  academicEvents AcademicEvent[]

  // Phase 5 Relations
  homework Homework[]
}

//////////////////////////
// SCHEDULE (PERIODS)
//////////////////////////

model Period {
  id           String  @id @default(uuid())
  batchId      String
  dayOfWeek    Int // 1=Mon, 2=Tue...6=Sat (0=Sun if needed)
  periodNumber Int
  startTime    String // "08:00"
  endTime      String // "08:45"
  subjectId    String?
  teacherId    String?

  batch   Batch    @relation(fields: [batchId], references: [id], onDelete: Cascade)
  subject Subject? @relation(fields: [subjectId], references: [id])
  teacher User?    @relation(fields: [teacherId], references: [id])

  @@unique([batchId, dayOfWeek, periodNumber])
}

model AttendanceSession {
  id             String   @id @default(uuid())
  orgId          String
  branchId       String
  batchId        String
  attendanceDate DateTime @db.Date
  createdById    String
  createdAt      DateTime @default(now())

  batch     Batch              @relation(fields: [batchId], references: [id])
  createdBy User               @relation(fields: [createdById], references: [id])
  records   AttendanceRecord[]

  @@unique([batchId, attendanceDate])
}

model AttendanceRecord {
  id                  String           @id @default(uuid())
  attendanceSessionId String
  studentId           String
  status              AttendanceStatus
  markedAt            DateTime         @default(now())

  session AttendanceSession @relation(fields: [attendanceSessionId], references: [id], onDelete: Cascade)
  student Student           @relation(fields: [studentId], references: [id])

  @@unique([attendanceSessionId, studentId])
}

//////////////////////////
// PHASE 3: FEE COMPONENTS & BATCH STRUCTURE
//////////////////////////

model FeeComponent {
  id          String           @id @default(uuid())
  orgId       String
  name        String           // "Tuition Fee", "Transport Fee"
  type        FeeComponentType
  description String?
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  organization         Organization           @relation(fields: [orgId], references: [id])
  batchFeeLineItems    BatchFeeLineItem[]
  studentFeeLineItems  StudentFeeLineItem[]
  scholarships         Scholarship[]          @relation("ScholarshipComponent")

  @@unique([orgId, type, name])
}

model BatchFeeStructure {
  id          String   @id @default(uuid())
  orgId       String
  branchId    String
  batchId     String
  sessionId   String   // Academic session this applies to
  name        String   // "2025-26 Fee Structure"
  totalAmount Int      // Computed sum of line items
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  batch                 Batch                  @relation(fields: [batchId], references: [id])
  session               AcademicSession        @relation(fields: [sessionId], references: [id])
  lineItems             BatchFeeLineItem[]
  studentFeeStructures  StudentFeeStructure[]

  @@unique([batchId, sessionId])
  @@index([orgId, branchId])
}

model BatchFeeLineItem {
  id                  String @id @default(uuid())
  batchFeeStructureId String
  feeComponentId      String
  amount              Int

  batchFeeStructure BatchFeeStructure @relation(fields: [batchFeeStructureId], references: [id], onDelete: Cascade)
  feeComponent      FeeComponent      @relation(fields: [feeComponentId], references: [id])

  @@unique([batchFeeStructureId, feeComponentId])
}

//////////////////////////
// PHASE 3: SCHOLARSHIPS
//////////////////////////

model Scholarship {
  id          String          @id @default(uuid())
  orgId       String
  name        String          // "Merit Scholarship", "Sibling Discount"
  type        ScholarshipType
  basis       ScholarshipBasis
  value       Int             // Percentage (0-100) or fixed amount
  componentId String?         // If type = component_waiver, which component to waive
  maxAmount   Int?            // Cap for percentage-based scholarships
  description String?
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  organization        Organization          @relation(fields: [orgId], references: [id])
  feeComponent        FeeComponent?         @relation("ScholarshipComponent", fields: [componentId], references: [id])
  studentScholarships StudentScholarship[]

  @@unique([orgId, name])
}

model StudentScholarship {
  id             String   @id @default(uuid())
  studentId      String
  scholarshipId  String
  sessionId      String   // Academic session this applies to
  discountAmount Int      // Calculated discount amount
  approvedById   String   // User who approved
  approvedAt     DateTime @default(now())
  remarks        String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())

  student     Student         @relation(fields: [studentId], references: [id])
  scholarship Scholarship     @relation(fields: [scholarshipId], references: [id])
  session     AcademicSession @relation(fields: [sessionId], references: [id])
  approvedBy  User            @relation("ScholarshipApprovedBy", fields: [approvedById], references: [id])

  @@unique([studentId, scholarshipId, sessionId])
  @@index([studentId])
  @@index([sessionId])
}

//////////////////////////
// PHASE 3: STUDENT FEE STRUCTURE
//////////////////////////

model StudentFeeStructure {
  id                  String             @id @default(uuid())
  studentId           String
  sessionId           String
  source              FeeStructureSource
  batchFeeStructureId String?            // Reference if copied from batch
  grossAmount         Int                // Total before scholarships
  scholarshipAmount   Int                @default(0)
  netAmount           Int                // Actual payable = gross - scholarship - customDiscount
  remarks             String?            // Any special notes
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  // Custom discount fields (student-specific one-off discounts)
  customDiscountType    String?   // "percentage" | "fixed_amount" | null
  customDiscountValue   Int?      // Input value (percentage 0-100 or amount in paise)
  customDiscountAmount  Int?      // Calculated discount in paise (always positive)
  customDiscountRemarks String?   // Optional reason for the discount

  student           Student              @relation(fields: [studentId], references: [id])
  session           AcademicSession      @relation(fields: [sessionId], references: [id])
  batchFeeStructure BatchFeeStructure?   @relation(fields: [batchFeeStructureId], references: [id])
  lineItems         StudentFeeLineItem[]
  installments      FeeInstallment[]

  @@unique([studentId, sessionId])
  @@index([sessionId])
}

model StudentFeeLineItem {
  id                    String  @id @default(uuid())
  studentFeeStructureId String
  feeComponentId        String
  originalAmount        Int     // From batch or custom
  adjustedAmount        Int     // After any component-level adjustments
  waived                Boolean @default(false)
  waiverReason          String?

  studentFeeStructure StudentFeeStructure @relation(fields: [studentFeeStructureId], references: [id], onDelete: Cascade)
  feeComponent        FeeComponent        @relation(fields: [feeComponentId], references: [id])

  @@unique([studentFeeStructureId, feeComponentId])
}

//////////////////////////
// PHASE 3: EMI & INSTALLMENTS
//////////////////////////

model EMIPlanTemplate {
  id               String   @id @default(uuid())
  orgId            String
  name             String   // "Quarterly", "Monthly", "Half-Yearly"
  installmentCount Int      // 4, 12, 2
  // JSON array of percentage splits and relative due dates
  // e.g., [{"percent": 25, "dueDaysFromStart": 0}, {"percent": 25, "dueDaysFromStart": 90}]
  splitConfig      Json
  isDefault        Boolean  @default(false)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())

  organization Organization @relation(fields: [orgId], references: [id])

  @@unique([orgId, name])
}

model FeeInstallment {
  id                    String            @id @default(uuid())
  studentFeeStructureId String
  installmentNumber     Int               // 1, 2, 3...
  amount                Int
  dueDate               DateTime
  paidAmount            Int               @default(0)
  status                InstallmentStatus @default(upcoming)
  reminderSentAt        DateTime?         // Last reminder timestamp
  reminderCount         Int               @default(0)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  studentFeeStructure StudentFeeStructure  @relation(fields: [studentFeeStructureId], references: [id], onDelete: Cascade)
  payments            InstallmentPayment[]
  reminders           FeeReminder[]
  paymentLinks        PaymentLink[]

  @@unique([studentFeeStructureId, installmentNumber])
  @@index([dueDate, status])
}

model InstallmentPayment {
  id             String      @id @default(uuid())
  installmentId  String
  amount         Int
  paymentMode    PaymentMode
  transactionRef String?     // UPI/Bank reference
  receivedById   String
  receivedAt     DateTime    @default(now())
  remarks        String?

  installment FeeInstallment @relation(fields: [installmentId], references: [id])
  receivedBy  User           @relation("InstallmentReceivedBy", fields: [receivedById], references: [id])
  receipt     Receipt?

  @@index([installmentId])
}

model FeeReminder {
  id             String             @id @default(uuid())
  installmentId  String
  parentId       String
  sentAt         DateTime           @default(now())
  channel        String             // "whatsapp" | "sms"
  status         NotificationStatus
  providerMsgId  String?

  installment FeeInstallment @relation(fields: [installmentId], references: [id])
  parent      Parent         @relation(fields: [parentId], references: [id])

  @@index([installmentId, sentAt])
}

//////////////////////////
// EVENTS & NOTIFICATIONS
//////////////////////////

model Event {
  id          String      @id @default(uuid())
  orgId       String
  branchId    String
  type        EventType
  payload     String // JSON string
  status      EventStatus @default(pending)
  processedAt DateTime?
  createdAt   DateTime    @default(now())

  organization Organization @relation(fields: [orgId], references: [id])
  branch       Branch       @relation(fields: [branchId], references: [id])
}

model MessageTemplate {
  id        String    @id @default(uuid())
  orgId     String
  type      String // absent | fee_due | fee_paid
  name      String?  // Display name for the template
  content   String
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  organization  Organization      @relation(fields: [orgId], references: [id])
  notifications NotificationLog[]
}

model NotificationLog {
  id                String             @id @default(uuid())
  orgId             String
  branchId          String
  recipientPhone    String
  templateId        String
  status            NotificationStatus @default(pending)
  providerMessageId String?
  errorMessage      String?
  entityType        String?
  entityId          String?
  metadata          Json?              // Delivery status, timestamps, etc.
  sentAt            DateTime           @default(now())

  branch   Branch          @relation(fields: [branchId], references: [id])
  template MessageTemplate @relation(fields: [templateId], references: [id])
}

//////////////////////////
// JOB RUNS (Scheduler Tracking)
//////////////////////////

model JobRun {
  id               String    @id @default(uuid())
  orgId            String?   // null for global/cross-org jobs
  branchId         String?
  jobName          String    // "event-processor", "fee-reminder", etc.
  status           JobStatus @default(running)
  startedAt        DateTime  @default(now())
  completedAt      DateTime?
  durationMs       Int?
  eventsEmitted    Int       @default(0)
  recordsProcessed Int       @default(0)
  errorMessage     String?   @db.Text
  metadata         String?   @db.Text // JSON for extra details

  organization Organization? @relation(fields: [orgId], references: [id])

  @@index([jobName, startedAt])
  @@index([status])
  @@index([orgId])
}

//////////////////////////
// STAFF ATTENDANCE
//////////////////////////

model StaffAttendance {
  id        String                @id @default(uuid())
  orgId     String
  branchId  String
  userId    String
  date      DateTime              @db.Date
  checkIn   DateTime?
  checkOut  DateTime?
  status    StaffAttendanceStatus @default(present)
  leaveType LeaveType?
  notes     String?
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt

  user         User         @relation(fields: [userId], references: [id])
  organization Organization @relation(fields: [orgId], references: [id])

  @@unique([userId, date])
  @@index([orgId, branchId, date])
}

//////////////////////////
// STUDENT LEAVE (Phase 4)
//////////////////////////

model LeaveApplication {
  id           String             @id @default(uuid())
  orgId        String
  branchId     String
  studentId    String
  parentId     String
  type         StudentLeaveType
  reason       String
  startDate    DateTime           @db.Date
  endDate      DateTime           @db.Date
  totalDays    Int
  status       StudentLeaveStatus @default(pending)
  reviewedById String?
  reviewedAt   DateTime?
  reviewNote   String?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  student    Student @relation(fields: [studentId], references: [id])
  parent     Parent  @relation(fields: [parentId], references: [id])
  reviewedBy User?   @relation("LeaveReviewedBy", fields: [reviewedById], references: [id])

  @@index([studentId, startDate])
  @@index([orgId, branchId, status])
}

//////////////////////////
// ACADEMIC CALENDAR
//////////////////////////

model AcademicEvent {
  id          String            @id @default(uuid())
  orgId       String
  branchId    String
  batchId     String?           // null = applies to all batches (school-wide)
  type        AcademicEventType
  title       String
  description String?
  startDate   DateTime          @db.Date
  endDate     DateTime?         @db.Date
  isAllDay    Boolean           @default(true)
  createdById String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  organization Organization @relation(fields: [orgId], references: [id])
  branch       Branch       @relation(fields: [branchId], references: [id])
  batch        Batch?       @relation(fields: [batchId], references: [id])
  createdBy    User         @relation("AcademicEventCreatedBy", fields: [createdById], references: [id])

  @@index([orgId, branchId, startDate])
  @@index([batchId])
}

//////////////////////////
// HOMEWORK & ASSIGNMENTS
//////////////////////////

model Homework {
  id          String         @id @default(uuid())
  orgId       String
  branchId    String
  batchId     String
  subjectId   String?
  title       String
  description String         @db.Text
  attachments Json?          // Array of {name, url}
  dueDate     DateTime
  totalMarks  Int?           // null if not graded
  status      HomeworkStatus @default(draft)
  createdById String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  organization Organization         @relation(fields: [orgId], references: [id])
  branch       Branch               @relation(fields: [branchId], references: [id])
  batch        Batch                @relation(fields: [batchId], references: [id])
  subject      Subject?             @relation("HomeworkSubject", fields: [subjectId], references: [id])
  createdBy    User                 @relation("HomeworkCreatedBy", fields: [createdById], references: [id])
  submissions  HomeworkSubmission[]

  @@index([batchId, dueDate])
  @@index([orgId, branchId, status])
}

model HomeworkSubmission {
  id           String           @id @default(uuid())
  homeworkId   String
  studentId    String
  status       SubmissionStatus @default(pending)
  submittedAt  DateTime?
  attachments  Json?            // Array of {name, url}
  marks        Int?
  feedback     String?
  gradedById   String?
  gradedAt     DateTime?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  homework Homework @relation(fields: [homeworkId], references: [id], onDelete: Cascade)
  student  Student  @relation(fields: [studentId], references: [id])
  gradedBy User?    @relation("SubmissionGradedBy", fields: [gradedById], references: [id])

  @@unique([homeworkId, studentId])
  @@index([studentId])
}

//////////////////////////
// RECEIPTS
//////////////////////////

model Receipt {
  id                   String      @id @default(uuid())
  orgId                String
  branchId             String
  receiptNumber        String      // Auto-generated: ORG-2026-00001
  installmentPaymentId String      @unique
  studentId            String
  amount               Int
  paymentMode          PaymentMode
  receivedById         String
  generatedAt          DateTime    @default(now())
  pdfPath              String?     // S3/local path to generated PDF

  organization       Organization       @relation(fields: [orgId], references: [id])
  installmentPayment InstallmentPayment @relation(fields: [installmentPaymentId], references: [id])
  student            Student            @relation(fields: [studentId], references: [id])
  receivedBy         User               @relation("ReceiptReceivedBy", fields: [receivedById], references: [id])

  @@unique([orgId, receiptNumber])
  @@index([orgId, branchId])
  @@index([studentId])
}

model ReceiptSequence {
  id         String @id @default(uuid())
  orgId      String
  year       Int
  lastNumber Int    @default(0)

  @@unique([orgId, year])
}

//////////////////////////
// PHASE 2B: PAYMENT LINKS
//////////////////////////

model PaymentLink {
  id              String            @id @default(uuid())
  orgId           String
  branchId        String
  installmentId   String?           // Reference to FeeInstallment
  shortCode       String            @unique // "abc123" for short URLs
  amount          Int
  description     String?
  razorpayLinkId  String?           @unique
  razorpayUrl     String?
  status          PaymentLinkStatus @default(active)
  expiresAt       DateTime
  paidAt          DateTime?
  createdById     String
  createdAt       DateTime          @default(now())

  installment FeeInstallment? @relation(fields: [installmentId], references: [id])
  createdBy   User            @relation("PaymentLinkCreatedBy", fields: [createdById], references: [id])

  @@index([shortCode])
  @@index([installmentId])
  @@index([orgId, status])
}

//////////////////////////
// PHASE 2B: REPORTS
//////////////////////////

model ReportGeneration {
  id            String       @id @default(uuid())
  orgId         String
  branchId      String?      // null for cross-branch reports
  type          ReportType
  format        ReportFormat
  parameters    Json         // Date range, filters
  filePath      String?      // Generated file path
  status        String       @default("pending") // pending, generating, completed, failed
  requestedById String
  createdAt     DateTime     @default(now())
  completedAt   DateTime?

  requestedBy User @relation(fields: [requestedById], references: [id])

  @@index([orgId, type])
  @@index([status])
}

//////////////////////////
// PHASE 2B: EXAMS & MARKS
//////////////////////////

model Exam {
  id           String    @id @default(uuid())
  orgId        String
  branchId     String
  batchId      String
  subjectId    String?   // null for combined exams
  name         String    // "Unit Test 1", "Mid-Term Exam"
  type         ExamType
  totalMarks   Int
  passingMarks Int
  examDate     DateTime
  isPublished  Boolean   @default(false)
  createdById  String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  batch     Batch       @relation(fields: [batchId], references: [id])
  subject   Subject?    @relation(fields: [subjectId], references: [id])
  createdBy User        @relation("ExamCreatedBy", fields: [createdById], references: [id])
  scores    ExamScore[]

  @@index([batchId, examDate])
  @@index([orgId, branchId])
}

model ExamScore {
  id            String   @id @default(uuid())
  examId        String
  studentId     String
  marksObtained Int?     // null = absent
  remarks       String?
  gradedById    String
  gradedAt      DateTime @default(now())

  exam     Exam    @relation(fields: [examId], references: [id], onDelete: Cascade)
  student  Student @relation(fields: [studentId], references: [id])
  gradedBy User    @relation("ExamScoreGradedBy", fields: [gradedById], references: [id])

  @@unique([examId, studentId])
}

//////////////////////////
// PHASE 2B: MESSAGING
//////////////////////////

model Conversation {
  id          String      @id @default(uuid())
  orgId       String
  branchId    String
  type        MessageType
  title       String?     // For broadcasts/announcements
  batchId     String?     // For batch broadcasts
  createdById String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  batch        Batch?                    @relation(fields: [batchId], references: [id])
  participants ConversationParticipant[]
  messages     Message[]

  @@index([orgId, branchId])
  @@index([batchId])
}

model ConversationParticipant {
  id             String    @id @default(uuid())
  conversationId String
  userId         String?   // Staff/Teacher
  parentId       String?   // Parent
  lastReadAt     DateTime?
  createdAt      DateTime  @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User?        @relation("UserParticipant", fields: [userId], references: [id])
  parent       Parent?      @relation("ParentParticipant", fields: [parentId], references: [id])

  @@unique([conversationId, userId])
  @@unique([conversationId, parentId])
  @@index([userId])
  @@index([parentId])
}

model Message {
  id             String   @id @default(uuid())
  conversationId String
  senderUserId   String?
  senderParentId String?
  content        String   @db.Text
  attachmentUrl  String?
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderUser   User?        @relation("MessageSentByUser", fields: [senderUserId], references: [id])
  senderParent Parent?      @relation("MessageSentByParent", fields: [senderParentId], references: [id])

  @@index([conversationId, createdAt])
}

//////////////////////////
// PHASE 2B: COMPLAINTS
//////////////////////////

model Complaint {
  id           String            @id @default(uuid())
  orgId        String
  branchId     String
  ticketNumber String            @unique // AUTO-001
  subject      String
  description  String            @db.Text
  category     String            // "fees", "academics", "facilities", "staff"
  priority     ComplaintPriority @default(medium)
  status       ComplaintStatus   @default(open)

  // Submitter (either parent or student context)
  submittedByParentId String?
  studentId           String?   // Which student is this about

  // Assignment
  assignedToId String?
  resolvedAt   DateTime?
  resolution   String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  submittedByParent Parent?            @relation("ComplaintSubmittedByParent", fields: [submittedByParentId], references: [id])
  student           Student?           @relation(fields: [studentId], references: [id])
  assignedTo        User?              @relation("ComplaintAssignedTo", fields: [assignedToId], references: [id])
  comments          ComplaintComment[]

  @@index([orgId, status])
  @@index([ticketNumber])
  @@index([submittedByParentId])
}

model ComplaintComment {
  id             String   @id @default(uuid())
  complaintId    String
  content        String   @db.Text
  authorUserId   String?
  authorParentId String?
  isInternal     Boolean  @default(false) // Internal notes not visible to parent
  createdAt      DateTime @default(now())

  complaint    Complaint @relation(fields: [complaintId], references: [id], onDelete: Cascade)
  authorUser   User?     @relation("ComplaintCommentByUser", fields: [authorUserId], references: [id])
  authorParent Parent?   @relation("ComplaintCommentByParent", fields: [authorParentId], references: [id])

  @@index([complaintId, createdAt])
}

//////////////////////////
// PHASE 2B: TICKET SEQUENCE
//////////////////////////

model ComplaintSequence {
  id         String @id @default(uuid())
  orgId      String @unique
  lastNumber Int    @default(0)
}

//////////////////////////
// PHASE 3: STUDENT HEALTH
//////////////////////////

model StudentHealth {
  id        String @id @default(uuid())
  studentId String @unique

  // Basic Vitals
  bloodGroup BloodGroup?
  heightCm   Float?      // in centimeters
  weightKg   Float?      // in kilograms

  // Medical History
  allergies          String? // Comma-separated: "Peanuts, Dust, Penicillin"
  chronicConditions  String? // "Asthma, Diabetes Type 1, Epilepsy"
  currentMedications String? // "Inhaler, Insulin"
  pastSurgeries      String? // "Appendectomy (2023)"

  // Sensory
  visionLeft     VisionStatus?
  visionRight    VisionStatus?
  usesGlasses    Boolean       @default(false)
  hearingStatus  HearingStatus?
  usesHearingAid Boolean       @default(false)

  // Physical
  physicalDisability String? // Description if any
  mobilityAid        String? // "Wheelchair", "Crutches"

  // Vaccinations (JSON object for flexibility)
  // {"BCG": "2015-01-10", "Polio": "2015-03-15", "MMR": "2016-01-20"}
  vaccinationRecords Json?

  // Insurance
  hasInsurance      Boolean   @default(false)
  insuranceProvider String?
  insurancePolicyNo String?
  insuranceExpiry   DateTime?

  // Emergency
  emergencyMedicalNotes String? // Special instructions for emergencies
  familyDoctorName      String?
  familyDoctorPhone     String?
  preferredHospital     String?

  // Checkup Tracking
  lastCheckupDate DateTime?
  nextCheckupDue  DateTime?

  // Dietary
  dietaryRestrictions String? // "Vegetarian", "No pork", "Lactose intolerant"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  student Student @relation(fields: [studentId], references: [id])
}

model HealthCheckup {
  id          String   @id @default(uuid())
  studentId   String
  checkupDate DateTime

  heightCm Float?
  weightKg Float?
  bmi      Float? // Calculated

  visionLeft  String? // "6/6", "6/12"
  visionRight String?

  bloodPressure String? // "120/80"
  pulse         Int?    // BPM

  dentalStatus String? // "Good", "Cavities", "Braces"

  findings        String? @db.Text
  recommendations String? @db.Text
  conductedBy     String? // Doctor/Nurse name

  createdAt DateTime @default(now())

  student Student @relation(fields: [studentId], references: [id])

  @@index([studentId, checkupDate])
}
